name: Test Android Manifest Patch

on:
  workflow_dispatch:

jobs:
  test-patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Build web assets (Vite)
        run: yarn build

      - name: Initialize Tauri Android project
        run: yarn tauri android init --ci

      - name: Show generated manifest BEFORE patch
        run: |
          echo "=== MANIFEST BEFORE PATCH ==="
          cat src-tauri/gen/android/app/src/main/AndroidManifest.xml || echo "Manifest not found"
          echo ""
          echo "=== APP BUILD.GRADLE.KTS BEFORE PATCH ==="
          cat src-tauri/gen/android/app/build.gradle.kts || echo "build.gradle.kts not found"

      - name: Patch Android manifest for USB support
        run: bash scripts/patch-android-manifest.sh

      - name: Show files after patch
        run: |
          echo "=== AndroidManifest.xml AFTER patch ==="
          cat src-tauri/gen/android/app/src/main/AndroidManifest.xml
          echo ""
          echo "=== Checking for USB permissions ==="
          grep -i "usb" src-tauri/gen/android/app/src/main/AndroidManifest.xml || echo "No USB permissions found!"
          echo ""
          echo "=== device_filter.xml ==="
          cat src-tauri/gen/android/app/src/main/res/xml/device_filter.xml || echo "device_filter.xml not found!"
          echo ""
          echo "=== MainActivity.kt ==="
          cat src-tauri/gen/android/app/src/main/java/com/betaflight/configurator/MainActivity.kt || echo "MainActivity.kt not found!"
          echo ""
          echo "=== app/build.gradle.kts dependencies ==="
          grep -A 10 "dependencies {" src-tauri/gen/android/app/build.gradle.kts || echo "No dependencies block found!"

      - name: Ensure JitPack repository
        shell: bash
        run: |
          set -euo pipefail
          FILE="src-tauri/gen/android/build.gradle.kts"
          if [ -f "$FILE" ]; then
            echo "=== ROOT BUILD.GRADLE.KTS BEFORE JITPACK ==="
            cat "$FILE"
            echo ""
            echo "Ensuring JitPack repository in $FILE..."
            if ! grep -q "jitpack.io" "$FILE"; then
              echo "Adding JitPack repository..."
              printf '\nallprojects {\n    repositories {\n        maven(url = "https://jitpack.io")\n    }\n}\n' >> "$FILE"
            fi
            echo ""
            echo "=== ROOT BUILD.GRADLE.KTS AFTER JITPACK ==="
            cat "$FILE"
          fi

      - name: Upload generated Android files
        uses: actions/upload-artifact@v4
        with:
          name: android-generated-files
          path: |
            src-tauri/gen/android/app/src/main/AndroidManifest.xml
            src-tauri/gen/android/app/src/main/res/xml/device_filter.xml
            src-tauri/gen/android/app/build.gradle.kts
            src-tauri/gen/android/build.gradle.kts
          retention-days: 7
