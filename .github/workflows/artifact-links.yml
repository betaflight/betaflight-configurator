name: Artifact links comments creator
on:
  workflow_run:
    workflows: ["Deployment (PR and Push)"]
    types: [completed]

jobs:
  artifacts-url-comments:
    name: Add artifact links to PR and issues
    runs-on: ubuntu-latest
    permissions:
      actions: read
      pull-requests: write
    # Only run for pull request events that succeeded
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(echo '${{ toJSON(github.event.workflow_run.pull_requests) }}' | jq -r '.[0].number')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Get artifact URLs
        id: artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          REPO="${{ github.repository }}"
          
          # Get all artifacts from the workflow run
          if ! ARTIFACTS=$(gh api "/repos/$REPO/actions/runs/$WORKFLOW_RUN_ID/artifacts" --jq '.artifacts'); then
            echo "Error: Failed to fetch artifacts" >&2
            exit 1
          fi
          
          # Build the markdown list of artifacts
          ARTIFACT_LINKS=""
          echo "$ARTIFACTS" | jq -r '.[] | "- [\(.name)](\(.archive_download_url))"' | while read -r line; do
            if [ -z "$ARTIFACT_LINKS" ]; then
              ARTIFACT_LINKS="$line"
            else
              ARTIFACT_LINKS="$ARTIFACT_LINKS"$'\n'"$line"
            fi
          done
          
          # Store in a file to preserve newlines
          echo "$ARTIFACTS" | jq -r '.[] | "- [\(.name)](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts/\(.id))"' > artifacts.txt
          
          # Build the markdown list of artifacts with download links
          ARTIFACT_LINKS=$(echo "$ARTIFACTS" | jq -r '.[] | "- [\(.name)](\(.archive_download_url))"')
          echo "links<<EOF" >> $GITHUB_OUTPUT
          echo "$ARTIFACT_LINKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post comment with artifact links
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr_number: ${{ steps.pr.outputs.number }}
          message: |
            ## üéâ Do you want to test this code? Here you have an automated build:
            
            ${{ steps.artifacts.outputs.links }}
            
            ‚ö†Ô∏è **WARNING**: It may be unstable and result in corrupted configurations or data loss. Use only for testing!
          comment-tag: 'artifact-links'
          mode: recreate
