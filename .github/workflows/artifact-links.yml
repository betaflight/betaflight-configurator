name: Artifact links comments creator
on:
  workflow_run:
    workflows: ["Deployment (PR and Push)"]
    types: [completed]

jobs:
  artifacts-url-comments:
    name: Add artifact links to PR and issues
    runs-on: ubuntu-latest
    permissions:
      actions: read
      pull-requests: write
    if: >
      github.event.workflow_run.event == 'pull_request_target' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get artifacts and post comment
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR number
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (!prNumber) {
              console.log('No PR found for this workflow run');
              return;
            }

            // Get artifacts from the workflow run
            const { data: { artifacts } } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            if (artifacts.length === 0) {
              console.log('No artifacts found');
              return;
            }

            // Build artifact links
            const artifactLinks = artifacts
              .map(artifact => `- [${artifact.name}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.payload.workflow_run.id}/artifacts/${artifact.id})`)
              .join('\n');

            // Post comment
            const commentBody = `## ðŸŽ‰ Do you want to test this code? Here you have an automated build:

            ${artifactLinks}

            âš ï¸ **WARNING**: It may be unstable and result in corrupted configurations or data loss. Use only for testing!`;

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ðŸŽ‰ Do you want to test this code?')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }
