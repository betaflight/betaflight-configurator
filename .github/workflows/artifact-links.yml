name: Artifact links comments creator
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  artifacts-url-comments:
    name: Add artifact links to PR and issues
    runs-on: ubuntu-latest
    # Only run if the CI workflow was triggered by a pull_request and succeeded
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    permissions:
      pull-requests: write
      actions: read
    steps:
      - name: 'Download artifact metadata'
        uses: actions/github-script@v7
        id: artifacts
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            
            let links = [];
            for (const artifact of artifacts.data.artifacts) {
              const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.payload.workflow_run.id}/artifacts/${artifact.id}`;
              links.push(`- [${artifact.name}](${url}) (${(artifact.size_in_bytes / 1024 / 1024).toFixed(2)} MB)`);
            }
            
            core.setOutput('artifact_links', links.join('\n'));
            core.setOutput('has_artifacts', links.length > 0);
            
      - name: 'Comment on PR'
        if: steps.artifacts.outputs.has_artifacts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0].number;
            const artifactLinks = process.env.ARTIFACT_LINKS;
            
            const body = `## üöÄ Build Artifacts Ready!
            
            Do you want to test this code? Here you have automated builds:
            
            ${artifactLinks}
            
            ‚ö†Ô∏è **WARNING:** These are preview builds and may be unstable. They could result in corrupted configurations or data loss. Use only for testing!`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
        env:
          ARTIFACT_LINKS: ${{ steps.artifacts.outputs.artifact_links }}
